$(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,ba,bb,bc,bd,be,bf,bg,bh,bi,bj,bk,bl,bm,bn,bo,bp,bq,br;j=$(".designer"),q=j.find(".options"),c=j.find(".card"),b=$("body"),e=$(".categories"),r=c.find(".qr"),s=r.find(".background"),h=c.find(".content"),br=$.line_copy;for(bn=0,bp=br.length;bn<bp;bn++)Z=br[bn],h.append('<div class="line">'+Z+"</div>");p=h.find(".line"),d=j.find(".category_field input"),f=j.find(".color1"),g=j.find(".color2"),o=j.find(".font_style"),k=o.find(".font_color"),l=o.find(".font_family"),m=o.find(".indicator"),n=o.find(".size .slider"),x=j.find(".qr_style"),t=x.find(".qr_color1"),u=x.find(".qr_color2"),w=x.find(".qr_radius"),v=x.find(".qr_color2_alpha"),a=$(".color"),G=$(".web_fg"),H=$(".web_fg2"),E=$(".web_bg"),y=j.find(".buttons .save"),D=j.find(".views"),A=D.find(".twelve"),F=D.find(".web"),z=D.find(".six"),i=j.find("form"),B=i.find("[type=file]"),I=!1,J=0,bf=!1,Q=!1,W=[],bb=[],L=0,O=0,M=0,N=0,bk=function(){return L=c.outerHeight(),O=c.outerWidth(),M=c.height(),N=c.width()},bk(),$.ajax({url:"/get-themes",success:function(a){var b,c,d,f,g;c=a.themes,e.html("");for(f=0,g=c.length;f<g;f++)d=c[f],b=$.create_card_from_theme({theme:d}),$.add_card_to_category(b,d);return e.find(".category:first h4").click()},error:function(){return $.load_alert({content:"Error loading themes. Please try again later."})}}),$(".category .card").live("click",function(){var a,b,c;b=$(this),c=b.data("theme"),I._id&&(a=$(".category .card"),a.each(function(){b=$(this);if(b.data("theme")&&b.data("theme")._id===I._id)return b.data("theme",I)}));if(c)return _(c),W=[c]}),U=["Arial","Comic Sans MS","Courier New","Georgia","Impact","Times New Roman","Trebuchet MS","Verdana","IM Fell English SC","Julee","Syncopate","Gravitas One","Quicksand","Vast Shadow","Smokum","Ovo","Amatic SC","Rancho","Poly","Chivo","Prata","Abril Fatface","Ultra","Love Ya Like A Sister","Carter One","Luckiest Guy","Gruppo","Slackey"].sort(),l.find("option").remove();for(bo=0,bq=U.length;bo<bq;bo++)T=U[bo],l.append('<option value="'+T+'" style="font-family:'+T+';">'+T+"</option>");return r.hide(),p.hide(),G.hide(),H.hide(),E.hide(),r.prep_qr(),be=1,b.keydown(function(a){var b,d,e,f;b=c.find(".active"),d=a.keyCode,a.keyCode===16&&(bf=!0,be=10);if(a.keyCode===17||a.keyCode===91||a.keyCode===93)Q=!0;Q&&!bf&&a.keyCode===90&&(a.preventDefault(),e=W.pop(),f=W[W.length-1],f?(bb.push(e),_(f)):(W.push(e),$(".modal").length===0&&$.load_alert({content:"No more to undo"}))),Q&&bf&&a.keyCode===90&&(a.preventDefault(),f=bb.pop(),f?(W.push(f),_(f)):(bb.push(f),$(".modal").length===0&&$.load_alert({content:"No more to redo"})));if(b.length&&!l.is(":focus")){b.each(function(){var a,b,c,e,f;a=$(this);if(d===38||d===40)e=parseInt(a.css("top")),d===38&&(e-=be),d===40&&(e+=be),f=(L-M)/2,b=f+M-a.outerHeight(),e<f&&(e=f),e>b&&(e=b),a.css("top",e),bd();if(d===37||d===39)return c=parseInt(a.css("left")),d===37&&(c-=be),d===39&&(c+=be),f=(O-N)/2,b=f+N-a.outerWidth(),c<f&&(c=f),c>b&&(c=b),a.css("left",c),bd()});if(d===38||d===40||d===39||d===37)return!1}}),b.keyup(function(a){if(a.keyCode===17||a.keyCode===91||a.keyCode===93)Q=!1;if(a.keyCode===16)return be=1,bf=!1}),a.each(function(){var a;return a=$(this),a.bind("color_update",function(b,c){return a.data({hex:c.hex}),a.css({background:"#"+c.hex})}),a.ColorPicker({livePreview:!0,onChange:function(b,c,d){return a.trigger("color_update",{hex:c,rgb:d,timer:!0})},onShow:function(b){return a.ColorPickerSetColor(a.data("hex"))}})}),k.bind("color_update",function(a,b){var d,e;e=$(this),d=c.find(".active"),d.each(function(){var a,c;return a=$(this),a.css({color:"#"+b.hex}),c=a.prevAll().length,I.theme_templates[J].lines[c].color=b.hex});if(b.timer)return bd()}),t.bind("color_update",function(a,b){r.draw_qr({color:b.hex});if(b.timer)return bd()}),u.bind("color_update",function(a,b){s.css({background:"#"+b.hex});if(b.timer)return bd()}),g.bind("color_update",function(a,b){return E.css({background:"#"+b.hex})}),K=function(a,b,c){var d,e,f,g,h,i;f=$.hexToR(a)+","+$.hexToG(a)+","+$.hexToB(a),d=["-moz-linear-gradient(top, rgba("+f+",0) "+b+",rgba("+f+",1) 99%)","-webkit-gradient(linear, left top, left bottom, color-stop("+b+",rgba("+f+",0)), color-stop(99%,rgba("+f+",1)))","-webkit-linear-gradient(top, rgba("+f+",0) "+b+",rgba("+f+",1) 99%)","-o-linear-gradient(top, rgba("+f+",0) "+b+",rgba("+f+",1) 99%)","-ms-linear-gradient(top, rgba("+f+",0) "+b+",rgba("+f+",1) 99%)","linear-gradient(top, rgba("+f+",0) "+b+",rgba("+f+",1) 99%)"],c.css({filter:"progid:DXImageTransform.Microsoft.gradient( startColorstr='#a6000000', endColorstr='#00000000',GradientType=0 )"}),i=[];for(g=0,h=d.length;g<h;g++)e=d[g],i.push(c.css({background:e}));return i},f.bind("color_update",function(a,b){return K(b.hex,"40%",G),K(b.hex,"80%",H)}),bl=function(){var a,b;return b=$(this),a=c.find(".active"),a.each(function(){var a,c;return a=$(this),a.css({"font-family":b.val()}),c=a.prevAll().length,I.theme_templates[J].lines[c].font_family=b.val()}),bd()},l.change(bl),bj=function(a){var b,d;return d=$(this),b=c.find(".active"),b.each(function(){var b,c;return b=$(this),b.css({"text-align":a}),c=b.prevAll().length,I.theme_templates[J].lines[c].text_align=a,bd()})},o.find(".left").click(function(){return bj("left")}),o.find(".center").click(function(){return bj("center")}),o.find(".right").click(function(){return bj("right")}),bh=function(a){var b;return b=c.find(".active"),b.each(function(){var b;return b=$(this),b.css({"font-size":a+"px","line-height":a+"px",height:a+"px"})}),m.html(a),n.slider("value",a)},bm=function(a){var b,d,e,f;return d=$(this),b=c.find(".active"),e=b.height(),f=e+a,bh(f),bd()},o.find(".increase").click(function(){return bm(1)}),o.find(".decrease").click(function(){return bm(-1)}),n.slider({min:1,max:75,step:5,slide:function(a,b){return bh(b.value),bd()}}),v.slider({min:0,max:100,step:5,slide:function(a,b){return s.fadeTo(0,b.value/100),I.theme_templates[J].qr.color2_alpha=b.value/100,bd()}}),w.change(function(){var a;return a=$(this),s.css({"border-radius":a.val()+"px"}),I.theme_templates[J].qr.radius=a.val(),bd()}),P=function(a){var b,c;c=q.find(a),b=q.find(".active");if(c[0]!==b[0])return b.find("ul").stop(!0,!0).slideUp(),b.removeClass("active"),c.find("ul").stop(!0,!0).slideDown(),c.addClass("active")},o.find("h4").click(function(){return P(".font_style"),p.first().mousedown(),p.filter(":visible").addClass("active"),!1}),x.find("h4").click(function(){return r.mousedown(),!1}),bg=function(a){var d;return d=$(a.target),d.hasClass("font_style")||d.closest(".font_style").length||d.hasClass("qr_style")||d.closest(".qr_style").length||d.hasClass("line")||d.hasClass("qr")||d.closest(".line").length||d.closest(".qr").length||d.closest(".colorpicker").length?d=null:(c.find(".active").removeClass("active"),b.unbind("click",bg),P(".defaults"))},p.mousedown(function(a){var d,e,f,g,h;return f=$(this),h=f.height(),d=c.find(".active"),bf||d.removeClass("active"),f.addClass("active"),b.bind("click",bg),P(".font_style"),g=f.prevAll().length,l[0].selectedIndex=null,k.trigger("color_update",{hex:I.theme_templates[J].lines[g].color}),e=l.find('option[value="'+I.theme_templates[J].lines[g].font_family+'"]'),e.focus().attr("selected","selected"),m.html(h),n.slider("value",h)}),r.mousedown(function(){var a,d;return d=$(this),a=c.find(".active"),a.removeClass("active"),d.addClass("active"),b.bind("click",bg),P(".qr_style")}),bc=0,X=0,bd=function(){return clearTimeout(X),X=setTimeout(function(){bi(),W.push($.extend(!0,{},I)),bb=[];if(!I.not_saved)return I.not_saved=!0,y.stop(!0,!0).slideDown()},200)},d.keyup(bd),p.draggable({grid:[10,10],containment:".designer .card",stop:bd}),p.resizable({grid:10,handles:"e, s, se",resize:function(a,b){var c,d;return c=$(b.element),d=c.height(),bh(d)},stop:bd}),r.draggable({grid:[10,10],containment:".designer .card",stop:bd}),r.resizable({grid:10,resize:function(a,b){var c,d,e;return c=$(b.element),d=c.height(),e=c.width(),c.find("canvas").css({height:d,width:e}),c.find(".background").css({height:d,width:e})},containment:".designer .card",handles:"se",aspectRatio:1,stop:bd}),B.change(function(){return i.submit()}),V=function(a){var b,c,d,e,f;return b=parseInt(a.height()),f=parseInt(a.width()),c=parseInt(a.css("left")),e=parseInt(a.css("top")),isNaN(b)||isNaN(f)||isNaN(e)||isNaN(c)?!1:d={h:Math.round(b/L*1e4)/100,w:Math.round(f/O*1e4)/100,x:Math.round(c/O*1e4)/100,y:Math.round(e/L*1e4)/100}},bi=function(){var a,b,c,e,h,i,j;e=V(r),I.category=d.val(),I.theme_templates[J].color1=f.data("hex"),I.theme_templates[J].color2=g.data("hex"),I.theme_templates[J].qr={x:e.x,y:e.y,h:e.h,w:e.w,color1:t.data("hex"),color2:u.data("hex"),color2_alpha:I.theme_templates[J].qr.color2_alpha,radius:I.theme_templates[J].qr.radius},i=I.theme_templates[J].lines,j=[];for(a=0,h=i.length;a<h;a++)b=i[a],c=V(p.filter(":eq("+a+")")),j.push(I.theme_templates[J].lines[a]={x:c.x,y:c.y,h:c.h,w:c.w,color:b.color,font_family:b.font_family,text_align:b.text_align});return j},S=function(a){var b;return bi(),b={theme:I,do_save:a?!0:!1},$.ajax({url:"/save-theme",data:JSON.stringify(b),success:function(b){b.success||j.find(".save").show_tooltip({message:"Error saving."});if(a)return a(b)},error:function(){j.find(".save").show_tooltip({message:"Error saving."});if(a)return a()}})},$.s3_result=function(a){return!ba()&&a?(I.theme_templates[J].s3_id=a,bd(),c.css({background:"url('//d3eo3eito2cquu.cloudfront.net/525x300/"+a+"')"})):$.load_alert({content:"I had trouble saving that image, please try again later."})},ba=function(){return I?!1:($.load_alert({content:"Please create or select a theme first"}),!0)},R={category:"",not_saved:!0,theme_templates:[{color1:"FFFFFF",color2:"000000",s3_id:"",qr:{color1:"000066",color2:"FFFFFF",color2_alpha:.9,radius:10,h:50,w:28.57,x:68.76,y:43.33},lines:function(){var a;a=[];for(Y=0;Y<=5;Y++)a.push({color:"000066",font_family:"Vast Shadow",text_align:"left",h:6.67,w:60,x:3.05,y:5+Y*10});return a}()}]},_=function(a){var b,e,h,i,j,k,l,m,n,o,q;k=a.theme_templates[J];if(!k){J===2&&(k=$.extend(!0,{},a.theme_templates[0]),delete k._id);if(J===1){k=$.extend(!0,{},a.theme_templates[0]),delete k._id,o=k.lines;for(l=0,m=o.length;l<m;l++)h=o[l],$.extend(!0,h,{h:h.h/1.5,w:h.w/1.5}),i=$.extend(!0,{},h),i.x=100-i.x-i.w,k.lines.push(i);k.qr.h=k.qr.h/1.5,k.qr.w=k.qr.w/1.5}a.theme_templates[J]=k}J===1&&a.theme_templates[J].lines.length>10&&a.theme_templates[J].lines.splice(10,5),a.not_saved?y.stop(!0,!0).show():y.stop(!0,!0).hide(),I=a,k.s3_id?c.css({background:"#FFFFFF url('//d3eo3eito2cquu.cloudfront.net/525x300/"+k.s3_id+"')"}):c.css({background:"#FFFFFF"}),J===2?(c.css,c.css({height:140,width:252,margin:"0 126px",padding:5,"background-repeat":"repeat-y","background-size":"100%"}),bk(),c.css({height:290}),G.show(),H.show(),E.show()):(c.css({height:280,width:505,padding:10,margin:0}),bk(),G.hide(),H.hide(),E.hide()),r.hide(),p.hide();if(J===0||J===1)r.show().css({top:k.qr.y/100*L,left:k.qr.x/100*O,height:k.qr.h/100*L,width:k.qr.h/100*L}),r.find("canvas").css({height:k.qr.h/100*L,width:k.qr.h/100*L}),s.css({"border-radius":k.qr.radius+"px",height:k.qr.h/100*L,width:k.qr.w/100*O,background:"#"+k.qr.color2}),s.fadeTo(0,k.qr.color2_alpha),r.draw_qr({color:k.qr.color1});q=k.lines;for(e=0,n=q.length;e<n;e++)j=q[e],b=p.eq(e),b.show().css({top:j.y/100*L,left:j.x/100*O,width:j.w/100*O+"px",height:j.h/100*L+"px",fontSize:j.h/100*L+"px",lineHeight:j.h/100*L+"px",fontFamily:j.font_family,textAlign:j.text_align,color:"#"+j.color});return d.val(a.category),f.trigger("color_update",{hex:k.color1}),g.trigger("color_update",{hex:k.color2}),t.trigger("color_update",{hex:k.qr.color1}),u.trigger("color_update",{hex:k.qr.color2}),v.slider("value",k.qr.color2_alpha*100),w.find("[value="+k.qr.radius+"]").attr("selected","selected")},$(".add_new").click(function(){var a,b,c;return c=$.extend(!0,{},R),W=[c],b=$('<div class="card" />'),b.css({background:"#FFF"}),b.data("theme",c),a=$(".categories .category[category=]"),a.length===0&&(a=$('<div class="category" category=""><h4>(no category)</h4><div class="cards"></div></div>'),e.prepend(a)),a.find(".cards").prepend(b),a.find("h4").click(),a.find("h4").click(),b.click()}),C=$(".views .option"),C.unbind().click(function(){var a,b;return a=$(this),C.filter(".active").removeClass("active"),a.addClass("active"),b=a.prevAll().length,J=b,_(I)}),y.click(function(){return ba()?!1:$.load_loading({},function(a){return S(function(b){var c;return a(),c=$.create_card_from_theme({theme:I}),I.not_saved=!1,I._id=b.theme._id,y.stop(!0,!0).slideUp(),c.addClass("active"),c.data("theme",I),$(".category .card.active").remove(),$.add_card_to_category(c,I),c.closest(".category").find("h4").click()})})}),j.find(".buttons .delete").click(function(){return ba()?!1:$.load_modal({content:"<p>Are you sure you want to permanently delete this template?</p>",height:160,width:440,buttons:[{label:"Delete",action:function(a){return I.active=!1,$.load_loading({},function(a){return S(function(){return a(),$(".category .card.active").remove(),$(".category:first h4").click()})}),a()}},{"class":"gray",label:"Cancel",action:function(a){return a()}}]})})})